# Module working-wheel 

A Viam module that integrates Google Calendar to control a physical status wheel based on calendar events.

## Model michaellee1019:working-wheel:google-calender-service

This service integrates with Google Calendar API to read calendar events and determine availability status. It's designed to work with a physical wheel that displays different statuses based on calendar events.

### Prerequisites

Before using this module, you need to set up Google Calendar API credentials:

1. Go to [Google Cloud Console](https://console.cloud.google.com/apis/credentials)
2. Create a new project or select an existing one
3. Enable the Google Calendar API
4. Create OAuth 2.0 Client ID (Desktop application type)
5. Download the credentials file as `credentials.json`

### Getting OAuth Token

#### Option 1: Use Pre-built Binary (Recommended)

Download the `get_token` binary for your platform from the [releases page](https://github.com/michaellee1019/working-wheel/releases) (included with each module release):

```bash
# Download the appropriate binary for your platform
# Available: get_token-linux-amd64, get_token-linux-arm64, get_token-darwin-arm64

# Make it executable
chmod +x get_token-<your-platform>

# Run it - may include bundled OAuth credentials, or provide your own
./get_token-<your-platform>

# To use your own credentials instead:
./get_token-<your-platform> --credentials /path/to/your/credentials.json
```

#### Option 2: Run from Source

```bash
# Install helper dependencies
pip install -r requirements-helper.txt

# Run the token generator script
python get_token.py

# Or run the package directly
python -m get_token
```

The tool will:
1. Open a browser for Google OAuth authentication
2. Generate the token payload
3. Print the `do_command` payload to console
4. Copy it to your clipboard

See [get_token documentation](src/get_token/README.md) for more details.

### Configuration

This model requires a motor component to be configured.

**Required Attributes:**
- `motor`: Name of the motor component that controls the wheel

**Optional Attributes:**
- `reverse_motor`: Set to `true` to reverse motor direction (default: `false`)

**Example Configuration:**

```json
{
  "motor": "wheel_motor"
}
```

**Configuration with reversed motor:**

```json
{
  "motor": "wheel_motor",
  "reverse_motor": true
}
```

The motor should be a standard Viam motor component configured for your wheel hardware. Use `reverse_motor` if your motor is wired backwards and moves in the opposite direction.

### DoCommand

#### set_credentials

Stores Google OAuth credentials for accessing the Calendar API.

**Arguments:**
- Credentials object containing OAuth tokens (generated by `get_token.py`)

**Example:**

```json
{
  "set_credentials": {
    "token": "ya29.a0AfH6SMBx...",
    "refresh_token": "1//0gX9Q...",
    "token_uri": "https://oauth2.googleapis.com/token",
    "client_id": "123456789.apps.googleusercontent.com",
    "client_secret": "YOUR_CLIENT_SECRET",
    "scopes": ["https://www.googleapis.com/auth/calendar.readonly"],
    "expiry": "2025-09-30T12:00:00.000000Z"
  }
}
```

**Returns:**

```json
{
  "success": true
}
```

**Note:** Use the `get_token.py` script to generate the exact payload format. The credentials are stored in `$VIAM_MODULE_DATA/token.json` for persistent access.

#### test_calendar_status

Tests the calendar status detection without moving the motor. Useful for debugging and verification.

**Example Request:**

```json
{
  "test_calendar_status": {}
}
```

**Returns:** Calendar status information (same as turn_wheel but without motor movement)

#### test_wheel

Manually move the wheel to a specific position for testing. This command bypasses calendar checking and is useful for:
- Testing motor control
- Verifying wheel positions
- Debugging motor issues
- Demonstrating different statuses

**Example Request:**

```json
{
  "test_wheel": "WORK_FROM_HOME"
}
```

**Valid Status Names:**
- `IN_MEETING`
- `GOING_TO_EVENT`
- `FOCUS_TIME`
- `OUT_OF_OFFICE`
- `WORK_FROM_HOME`
- `AVAILABLE`

**Example Response:**

```json
{
  "motor_action": "moved",
  "old_position": 5,
  "current_position": 4,
  "revolutions_moved": -0.1666,
  "test_mode": true,
  "target_status": "WORK_FROM_HOME",
  "target_position": 4
}
```

**Error Response (invalid status):**

```json
{
  "error": "Invalid status name. Must be one of: IN_MEETING, GOING_TO_EVENT, FOCUS_TIME, OUT_OF_OFFICE, WORK_FROM_HOME, AVAILABLE",
  "current_position": 5,
  "valid_statuses": ["IN_MEETING", "GOING_TO_EVENT", "FOCUS_TIME", "OUT_OF_OFFICE", "WORK_FROM_HOME", "AVAILABLE"]
}
```

#### turn_wheel

Detects the current calendar status and physically moves the wheel to display the appropriate status.

**Behavior:**

- **On First Call After Reconfiguration**: Performs a full 360° rotation at 25 RPM to reset the wheel to a known position (OUT_OF_OFFICE)
- **Subsequent Calls**: Reads calendar status and moves to the appropriate position
- **Movement**: Uses `go_for` API at 25 RPM for relative motor movements
- **Position Tracking**: Maintains state of current position to calculate relative movements

**Wheel Positions:**

The wheel has 6 positions, each 1/6 of a full rotation (60°):

0. **IN_MEETING (0)**: Currently in a busy event (transparency = opaque)
1. **AVAILABLE (1)**: No other conditions are met
2. **FOCUS_TIME (2)**: Currently in a focus time block
3. **GOING_TO_EVENT (3)**: Busy event starting within the next 5 minutes
4. **WORK_FROM_HOME (4)**: All-day or current working location = home
5. **OUT_OF_OFFICE (5)**: All-day or current out-of-office event

**Precedence:** When multiple events overlap, the lowest numbered status takes priority.

**Example Request:**

```json
{
  "turn_wheel": {}
}
```

**Example Response (moving from OUT_OF_OFFICE to IN_MEETING):**

```json
{
  "status": 0,
  "status_name": "IN_MEETING",
  "event_summary": "Team Standup",
  "event_start": {
    "dateTime": "2025-09-30T10:00:00-07:00"
  },
  "event_end": {
    "dateTime": "2025-09-30T10:30:00-07:00"
  },
  "event_type": "default",
  "motor_action": "moved",
  "old_position": 5,
  "current_position": 0,
  "revolutions_moved": -0.8333
}
```

**Example Response (no movement needed):**

```json
{
  "status": 1,
  "status_name": "AVAILABLE",
  "message": "No events found matching criteria",
  "motor_action": "none",
  "current_position": 1,
  "revolutions_moved": 0
}
```

**How it works:**

1. **Reset Phase (first call after reconfigure)**:
   - Performs 1 full revolution (360°) at 25 RPM using `go_for`
   - Sets wheel to OUT_OF_OFFICE position (position 5)
   
2. **Calendar Check**:
   - Fetches all events for the current day from your primary calendar
   - Evaluates each event based on:
     - Event type (`eventType` field: `outOfOffice`, `focusTime`, etc.)
     - Transparency (`opaque` = busy, `transparent` = free)
     - Working location (`workingLocationProperties.type`: `homeOffice`)
     - Event timing (current, upcoming in 5 minutes, or all-day)
   - Determines the highest precedence status
   - Automatically refreshes OAuth tokens if expired

3. **Motor Movement**:
   - Calculates offset: `(target_position - current_position) / 6` revolutions
   - Moves motor using `go_for` at 25 RPM (relative movement)
   - Updates tracked position
   - Example: Moving from FOCUS_TIME (2) to IN_MEETING (0) = -2/6 = -0.333 revolutions

### Testing

You can test the `turn_wheel` functionality locally before deploying the module:

```bash
# Make sure you have credentials set up
python get_token.py

# Run the test script
python tst/test_turn_wheel.py
```

The test script will:
- Load credentials from `token.json`
- Fetch your calendar events
- Display the detected status and event details
- Show debug information about the detection process
